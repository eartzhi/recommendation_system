# Дипломный проект. “Рекомендательная система”

## Оглавление   
[1. Постановка задачи](#1-постановка-задачи)   
[2. Формат исходных данных](#2-формат-исходных-данных)    
[3. Построение валидации](#3-построение-валидации)    
[4. Трансформации исходного датасета](#4-трансформации-исходного-датасета)      
[5. Эксперименты](#5-эксперименты)    
[6. Создание Docker образа](#6-создание-docker-образа)    
[7. API](#7-apiI)        
[8. Результаты](#8-результаты)      


### 1. Постановка задачи    
Дипломный проект второго года обучения "Рекомендательная система".  

Цель работы: Повысить прибыль от допродаж в интернет-магазине Заказчика на 20%. С этой целью построить рекомендательную систему товаров для выдачи топ трех товаров, рекомендуемых пользователю.  

Метрика качества: Precision@3.  

:arrow_up:[к оглавлению](#оглавление)


### 2. Формат исходных данных

[Исходные данные](https://drive.google.com/drive/folders/1_87paoN6Kll-oPM-pkbrkSqDj6UnzbNm?usp=sharing "Ссылка для скачивания данных")    

Исходные данные предсталены четыремя фалами с набором данных:  
*events.csv* - набор событий  
*item_properties_part1.csv, item_properties_part2.csv* - соотношение товаров и их свойств  
*category_tree.csv* - соотношение категорий с родительской категорией товара  

После импорта и объединения двух частей файла item_properties получили следующие датафреймы:
**events — датасет с событиями.**   
**Колонки:**  
- *timestamp* — время события (int64)
- *visitorid* — идентификатор пользователя (int64)
- *event* — тип события (object)
    - *view* (просмотр карточки товара)  
    - *addtocart* (добавление в корзину)  
    - *transaction* (покупка)
- *itemid* — идентификатор объекта (int64)
- *transactionid* — идентификатор транзакции, если она проходила (float64)

**category_tree — файл с деревом категорий (можно восстановить дерево).**  
**Колонки:**    
- *category_id* — идентификатор категорий (int64)
- *parent_id* — идентификатор родительской категории (float64)


**item_properties — файл с свойствами товаров.**  
**Колонки:**  
- *timestamp* — момент записи значения свойства (int64)
- *item_id* — идентификатор объекта (int64)
- *property* — свойство. Все, кроме категории, захешированы (object) 
- *value* — значение свойства (object)

:arrow_up:[к оглавлению](#оглавление)


### 3. Построение валидации

После получения датасета событий с целью создания валидационной выборки датафрейм был отсортирован по возрастанию параметра timestamp.   Тестовая выборка составляет 20% от датасета events. Разделение организовано по времени  

:arrow_up:[к оглавлению](#оглавление)


### 4. Трансформации исходного датасета 

1. Для каждого товара было выделено по 4 категории товара в соотвествии сдатасетом item_properties.  
2. Из общих чеков на товар для каждого купленого товара был о выделено два товара, чаще всего присутствующих в чеке с рассматриваемым товаром.  
3. Для каждого товара добавлено по 4 родительских категории товара в соотвествии сдатасетом category_tree.  
4. Для каждого пользователя добавлен id чаще всего просматриваемого товара.  
5. Для каждого пользователя добавлено 4 чаще всего просматриваемые категории.  
6. Для каждого пользователя добавлен id товара чаще всего добавляемого в корзину.  
7. Для каждого пользователя добавлено 4 категории товаров чаще всего добавляемых в корзину.  
8. Для каждого пользователя добавлен id чаще всего покупаемого товара.  
9. Для каждого пользователя добавлено 4 категории чаще всего покупаемых товаров.  
10. На основании наибольшей активности пользователя для каждого пользователя добавлено любимое время суток.  

Все признаки сведены в единый тренировочный датасет.

тогом работы стали следующие датасеты:
**items — признаки товара**   
**Колонки:**  
- *itemid* — идентификатор объекта 
- *item_category_1* — первая категория товаров
- *item_category_2* — вторая категория товаров
- *item_category_3* — третья категория товаров
- *item_category_4* — четвертая категория товаров
- *item_parent_category_1* — родительская категория первой категории товаров
- *item_parent_category_2* — родительская категория второй категории товаров
- *item_parent_category_3* — родительская категория третьей категории товаров
- *item_parent_category_4* — родительская категория четвертой категории товаров
- *buy_with_1* — первый сопутствующий товар
- *buy_with_2* — второй сопутствующий товар

**users — характеристики пользователя**   
**Колонки:**  
- *visitorid* — идентификатор пользователя 
- *itemid_viewed* — наиболее просматириваемый пользователем товар 
- *item_category_1_viewed* — первая наиболее просматриваемая категория товаров
- *item_category_2_viewed* — вторая наиболее просматриваемая категория товаров
- *item_category_3_viewed* — третья наиболее просматриваемая категория товаров
- *item_category_4_viewed* — четвертая наиболее просматриваемая категория товаров
- *itemid_added* — товар, чаще всего добавляемый пользователем в корзину 
- *item_category_1_added* — первая категория товара, чаще всего добавляемый пользователем в корзину
- *item_category_2_added* — вторая категория товара, чаще всего добавляемый пользователем в корзину
- *item_category_3_added* — третья категория товара, чаще всего добавляемый пользователем в корзину
- *item_category_4_added* — четвертая категория товара, чаще всего добавляемый пользователем в корзину
- *itemid_buyed* — чаще всего покупаемый товар
- *item_category_1_buyed* — первая чаще всего покупаемая категория товаров
- *item_category_2_buyed* — вторая чаще всего покупаемая категория товаров
- *item_category_3_buyed* — третья чаще всего покупаемая категория товаров
- *item_category_4_buyed* — четвертая чаще всего покупаемая категория товаров
- *time_of_day_favorite* — время наибольшей активности пользователя
- *dayofweek_favorite* — день недели наибольшей активности пользователя

**events_train_feature — тренировочный датасет с событиями и признаками товаров и пользователей.**   
**Колонки:**  
- *timestamp* — время события
- *visitorid* — идентификатор пользователя
- *event* — тип события
    - *view* (просмотр карточки товара)  
    - *addtocart* (добавление в корзину)    
    - *transaction* (покупка)  
- *itemid* — идентификатор объекта  
- *transactionid* — идентификатор транзакции, если она проходила    
- *item_category_1* — первая категория товаров  
- *item_category_2* — вторая категория товаров  
- *item_category_3* — третья категория товаров  
- *item_category_4* — четвертая категория товаров  
- *item_parent_category_1* — родительская категория первой категории товаров  
- *item_parent_category_2* — родительская категория второй категории товаров  
- *item_parent_category_3* — родительская категория третьей категории товаров  
- *item_parent_category_4* — родительская категория четвертой категории товаров  
- *buy_with_1* — первый сопутствующий товар  
- *buy_with_2* — второй сопутствующий товар  
- *visitorid* — идентификатор пользователя   
- *itemid_viewed* — наиболее просматириваемый пользователем товар  
- *item_category_1_viewed* — первая наиболее просматриваемая категория товаров  
- *item_category_2_viewed* — вторая наиболее просматриваемая категория товаров  
- *item_category_3_viewed* — третья наиболее просматриваемая категория товаров  
- *item_category_4_viewed* — четвертая наиболее просматриваемая категория товаров  
- *itemid_added* — товар, чаще всего добавляемый пользователем в корзину   
- *item_category_1_added* — первая категория товара, чаще всего добавляемый пользователем в корзину  
- *item_category_2_added* — вторая категория товара, чаще всего добавляемый пользователем в корзину  
- *item_category_3_added* — третья категория товара, чаще всего добавляемый пользователем в корзину  
- *item_category_4_added* — четвертая категория товара, чаще всего добавляемый пользователем в корзину  
- *itemid_buyed* — чаще всего покупаемый товар  
- *item_category_1_buyed* — первая чаще всего покупаемая категория товаров  
- *item_category_2_buyed* — вторая чаще всего покупаемая категория товаров  
- *item_category_3_buyed* — третья чаще всего покупаемая категория товаров  
- *item_category_4_buyed* — четвертая чаще всего покупаемая категория товаров  
- *time_of_day_favorite* — время наибольшей активности пользователя  
- *dayofweek_favorite* — день недели наибольшей активности пользователя  


Для обучения моделей, работающих на основании рейтингов были произведены следующие трансформации:  
1. Определена бальная шкала действий пользователей: view=1, addtocart=5, transaction=10  
2. Определены понижающие коэффициенты длякатегорий и родительских категорий: для категорий=0.1, для родительских категорий 0.01  
3. Составден датасет ratings в котором соотношение пользователь-товар получает 1 бал если он пользователь просмотрел товар, 5 баллов если добавил товар в корзину, 10 баллов если купил товар. Так же для категорий и родительских категорий: Если пользватель просмотрел товар данной категории, то все товары данной категории для пользователя поднимаются в рейтинге на 1x0.1, добавил корзину - 5x0.01, купил - 10x0.1. Для родительской категории аналогично, но с коэффициентом 0.01.  

В результате получаем датасет с соотношением пользователь-товар и соответствующим рейтингом.  

:arrow_up:[к оглавлению](#оглавление)


### 5. Эксперименты:  

В рамках данной работы было проведено 4 эксперимента:  

#### 5.1 Коллаборативная фильтрация

Для модели KNNWithMeans из библиотеки surprice были проведены эксперрименты на следующей выборке гиперпараметров:  

    'k': [30, 40, 50, 100],
    'min_k ': [2, 3, 10],
    'sim_options': {
        'name': ['msd', 'cosine'],
        'min_support': [1, 5],
        'user_based': [True],
        'random_state': [42]
    }

Наилучший результат был достигнут при конфигурации {'k': 30, 'min_k ': 2, 'sim_options': {'name': 'cosine', 'min_support': 5, 'user_based': True, 'random_state': 42}}  

Метрика Presission@3:  0.001349527665317139  

#### 5.2 Факторизационные машины

Для модели LightFM из библиотеки lightfm были проведены эксперрименты на следующей выборке гиперпараметров:  

    'no_components': [1, 5, 10, 25, 50, 100],
    'loss': ['logistic']
    
Ни один набор гиперпараметров не дал результата  

Метрика Presission@3:  0.0  

#### 5.3 XGBoost для задачи классификации

Для модели XGBClassifier из библиотеки xgboost были проведены эксперрименты на следующей выборке гиперпараметров:  

    'n_estimators': [100, 200, 300],
    'learning_rate': [0.01, 0.05, 0.1],
    'max_depth': [3, 5, 7],
    # 'subsample': [0.7, 0.8, 0.9],
    # 'colsample_bytree': [0.7, 0.8, 0.9], 
    'random_state':[42],
    'enable_categorical':[True]
    

Наилучший результат был достигнут при конфигурации {'enable_categorical': True, 'learning_rate': 0.1, 'max_depth': 7, 'n_estimators': 300, 'random_state': 42}  

Метрика Presission@3:  0.0  

#### 5.4 Матричная факторизация

Для модели SVD из библиотеки surprice были проведены эксперрименты на следующей выборке гиперпараметров:  

    "n_epochs": [5, 10], 
    "lr_all": [0.002, 0.005], 
    "reg_all": [0.4, 0.6], 
    'random_state': [42]
    

Наилучший результат был достигнут при конфигурации {'n_epochs': 10, 'lr_all': 0.005, 'reg_all': 0.4, 'random_state': 42}  

Метрика Presission@3:  0.004452840372419377  

В работу принимаем модель на основе SVD из библиотеки surprice  

:arrow_up:[к оглавлению](#оглавление)


### 6. Создание Docker образа

Был создан докер контейнер на основе образа python:3.11.13  

**Внимание! Для стабильной работы требуется не менее 32Гб оперативной памяти.**

```dockerfile
FROM python:3.11.13

LABEL "maintainer"="eartzhi" \
      "app"="recomendation_server" \
      "version"="0.91"

COPY . /app
WORKDIR /app

ENV SERVER_USER="shop"
ENV PASSWORD="password"
ENV RES_PASSWORD="password2"

RUN pip install --upgrade pip
RUN pip install -r requirements.txt


CMD ["python", "server.py" ]


EXPOSE 5000
```

ENV SERVER_USER=shop  
ENV PASSWORD=password  
Переменные окружения для определения имени пользователя и пароля для обращения к API рекомендательной системы. При необходимости значения переменных можно изменить.  

ENV RES_PASSWORD=password2  
Переменная окружения для определения пароля для озапроса переобучения модели рекомендательной системы. При необходимости значение переменной можно изменить.  

Остальные параметры изменять не рекомендуется.  

Сборка образа осуществляется командой:  
docker build --no-cache -t recomendation_server ..\server   

Запуск командой:  
docker run --name recomendation_server -it --memory-swap=-1 --restart always -p 5000:5000 recomendation_server:latest  

При необходимости корректировать модель образ можно запускать командой:  
docker run --name recomendation_server -it -v "path:/app/data" --memory-swap=-1 --restart always -p 5000:5000 recomendation_server:latest  
path-путь к монтируемой папке на хост машине.  

:arrow_up:[к оглавлению](#оглавление)


### 7. API

По запросу GET http://HostIP:5000/user/<userid>  
выдается ответ в формате json следующего содержания:   
    {'itemid_1': itemid,  
     'itemid_2': itemid,  
     'itemid_3': itemid}  
Где значения параметров itemid_1...itemid_3 это id товаров, рекомендованых пользователю с запрашиваемым id.  
При отсутствии информации сервер вернет json {'error': 'Not found'}.  


Для проверки можно использовать команду  
curl -u shop:password http://HostIP:5000/user/1  


**Внимание! Для стабильной работы функции переобучения требуется не менее 64Гб оперативной памяти.**  
По запросу POST http://HostIP:5000/relearning с передачей параметров {"command": "relearning", "password": "password2", "parameters":   parameters} произойдет переобучение модели на данных имеющихся в папке .data при заданных параметрах.  
При завершени обучения с ошибкой API вернет json с описанием ошибки {'result': "error_text"}  

При неуспешной авторизации пользователя API вернет json {'error': 'Unauthorized access'}  


Адрес http://HostIP::5000/metrics предназначен для съема метрик через Prometheus  
metric_request_counter('requests', 'count of outer requests for prediction') - количество запросов пользователей;  
metric_learning_counter('learning', 'count of outer requests for learning') - количество запусков переобучения;  
metric_error_counter('error', 'count of errors in lerning') - количество ошибок при обучении;  
metric_request_time('request_processing_seconds', 'Time spent processing request') - время выполнения запроса;  
metric_learning_time('learning_processing_seconds', 'Time spent learning request') - время выполнения переобучения.  

:arrow_up:[к оглавлению](#оглавление)


### 8. Результаты

В рамках работы максимальный результат достигнутый на модели SVD из библиотеки surprice составляет Presission@3:  0.00445.  

При таких значениях метрики можем предположить увеличение числа продаж на 44,5%.  

:arrow_up:[к оглавлению](#оглавление)